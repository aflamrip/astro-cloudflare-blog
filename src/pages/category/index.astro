---
import { getLiveCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";

const { entries: allPosts } = await getLiveCollection("blog");

// Get unique categories and count posts
const categoryCounts: Record<
  string,
  { name: string; count: number; slug: string }
> = {};

(allPosts || []).forEach((post) => {
  if (post.data.category_slug) {
    const slug = post.data.category_slug;
    if (!categoryCounts[slug]) {
      categoryCounts[slug] = {
        name: post.data.category_name || "Uncategorized",
        slug: slug,
        count: 0,
      };
    }
    categoryCounts[slug].count++;
  }
});

const sortedCategories = Object.values(categoryCounts).sort(
  (a, b) => b.count - a.count,
);
---

<Layout title="Categories">
  <main class="my-16">
    <header class="mb-12">
      <h1
        class="text-xs font-bold uppercase tracking-widest text-text-mute mb-2"
      >
        Structure
      </h1>
      <h2 class="text-5xl font-extrabold tracking-tighter">Categories</h2>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      {
        sortedCategories.map((cat) => (
          <a
            href={`/category/${cat.slug}`}
            class="group p-8 bg-border/10 rounded-3xl hover:bg-ui/5 transition-all border border-border/5 hover:border-ui/20 flex justify-between items-center"
          >
            <div>
              <h3 class="text-2xl font-bold group-hover:text-ui transition-colors">
                {cat.name}
              </h3>
              <p class="text-xs font-bold uppercase tracking-widest text-text-mute mt-2 opacity-50">
                {cat.count} {cat.count === 1 ? "Article" : "Articles"}
              </p>
            </div>
            <div class="p-3 rounded-full bg-bg border border-border/10 group-hover:border-ui/30 group-hover:translate-x-1 transition-all">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2.5"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="text-text-mute group-hover:text-ui"
              >
                <path d="m9 18 6-6-6-6" />
              </svg>
            </div>
          </a>
        ))
      }
    </div>

    {
      sortedCategories.length === 0 && (
        <div class="py-20 text-center border-2 border-dashed border-border/20 rounded-3xl">
          <p class="text-text-mute italic">No categories created yet.</p>
          <a
            href="/admin/editor"
            class="mt-4 inline-block text-ui font-bold hover:underline"
          >
            Start writing â†’
          </a>
        </div>
      )
    }
  </main>
</Layout>
